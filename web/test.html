<!DOCTYPE html>
<html>
<head>
<title>Write MIDI File</title>
<script src="../github/JZZ-master/javascript/JZZ.js"></script>
<script src="../github/JZZ-synth-Tiny-master/javascript/JZZ.synth.Tiny.js"></script>
<script src="../github/JZZ-midi-SMF-master/javascript/JZZ.midi.SMF.js"></script>
</head>

<body>
<h1>Write MIDI File</h1>

<h2>from Base64 string: <button onclick='fromBase64();'>Read...</button></h2>
<p id=log>no file selected</p>
<p><button id=btn onclick='playStop()' disabled>Play</button></p>

<div id="out"></div>

<script><!--

var smf = new JZZ.MIDI.SMF(1, 100);

// Add MIDI file tracks:
var trk0 = new JZZ.MIDI.SMF.MTrk(); smf.push(trk0); // First track in Type 1 MIDI file is normally used for tempo changes
var trk2 = new JZZ.MIDI.SMF.MTrk(); smf.push(trk2); // This one will be for the music

trk0.smfBPM(120); // Tempo. Normally set at clock 0, but can be also changed later


trk2.smfSeqName('Music')
    .ch(0) // all subsequent messahes will go to channel 0
    .program(0x18) // set channel 0 program to vibraphone
    .tick(100).note('G4').note('C4') // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('E4', 100, 50) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('E4', 100, 100) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(150).note('F4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('D4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('D4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G4', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G3', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G3', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).note('G3', 100, 10) // clock: 100, MIDI channel: 0, note: E5, velocity: 127, duration: 50 clocks
    .tick(100).smfEndOfTrack(); // otherwise it will end on clock 1690

var str = smf.dump(); // MIDI file dumped as a string
var b64 = JZZ.lib.toBase64(str); // convert to base-64 string
var uri = 'data:audio/midi;base64,' + b64; // data URI

// Finally, write it to the document as a link and as an embedded object:
document.getElementById('out').innerHTML = 'New file: <a href=' + uri + '>DOWNLOAD</a> <object src=' + uri + ' autostart=true>';
</script>
<script><!--
var log = document.getElementById('log');
var btn = document.getElementById('btn');
function report(s) { return function() { log.innerHTML = s; }; }

JZZ.synth.Tiny.register('Web Audio');
var out = JZZ().or(report('Cannot start MIDI engine!')).openMidiOut().or(report('Cannot open MIDI Out!'));
var player;
var playing = false;

function clear() {
  if (player) player.stop();
  playing = false;
  log.innerHTML = 'please wait...';
  btn.innerHTML = 'Play';
  btn.disabled = true;
}

function load(data, name) {
  try {
    player = JZZ.MIDI.SMF(data).player();
    player.connect(out);
    player.onEnd = function() {
      playing = false;
      btn.innerHTML = 'Play';
    }
    playing = true;
    player.play();
    log.innerHTML = name;
    btn.innerHTML = 'Stop';
    btn.disabled = false;
  }
  catch (e) {
    log.innerHTML = e;
  }
}

function playStop() {
  if (playing) {
    player.stop();
    playing = false;
    btn.innerHTML = 'Play';
  }
  else {
    player.play();
    playing = true;
    btn.innerHTML = 'Stop';
  }
}

function fromBase64() {
  clear();
  load(JZZ.lib.fromBase64(b64), 'BaSse64 data');
  console.log(b64);
}

--></script>
</body>
</html>
